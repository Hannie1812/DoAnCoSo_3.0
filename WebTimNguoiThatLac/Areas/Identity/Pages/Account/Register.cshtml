@page
@model RegisterModel
@{
    ViewData["Title"] = "Đăng ký tài khoản";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0 text-white">Đăng ký tài khoản</h3>
                </div>
                <div class="card-body">
                    <form id="registerForm" asp-route-returnUrl="@Model.ReturnUrl" method="post" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

                        <div class="mb-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Quy trình đăng ký:
                                <ol class="mb-0 mt-2">
                                    <li>Điền thông tin cá nhân</li>
                                    <li>Tải lên ảnh CCCD</li>
                                    <li>Chụp ảnh khuôn mặt</li>
                                    <li>Xác thực khuôn mặt</li>
                                    <li>Hoàn tất đăng ký</li>
                                </ol>
                            </div>
                        </div>

                        <!-- Thông tin cá nhân -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Thông tin cá nhân</h5>
                            </div>
                            <div class="card-body">
                                <!-- Email Input -->
                                <div class="form-floating mb-3">
                                    <input asp-for="Input.Email" class="form-control" autocomplete="username" required placeholder="name@example.com" />
                                    <label asp-for="Input.Email">Email</label>
                                    <span asp-validation-for="Input.Email" class="text-danger"></span>
                                </div>

                                <!-- Full Name Input -->
                                <div class="form-floating mb-3">
                                    <input asp-for="Input.FullName" class="form-control" required placeholder="Họ và tên" />
                                    <label asp-for="Input.FullName">Họ và tên</label>
                                    <span asp-validation-for="Input.FullName" class="text-danger"></span>
                                </div>

                                <!-- CCCD Number Input -->
                                <div class="form-group mb-3">
                                    <label asp-for="Input.CCCD"><i class="fas fa-id-card"></i> Số CCCD</label>
                                    <input asp-for="Input.CCCD" id="cccdInput" class="form-control" required />
                                    <span asp-validation-for="Input.CCCD" class="text-danger"></span>
                                </div>

                                <!-- Address Input -->
                                <div class="form-floating mb-3">
                                    <input asp-for="Input.Address" class="form-control" required placeholder="Địa chỉ" />
                                    <label asp-for="Input.Address">Địa chỉ</label>
                                    <span asp-validation-for="Input.Address" class="text-danger"></span>
                                </div>

                                <!-- Password Inputs -->
                                <div class="form-floating mb-3">
                                    <input asp-for="Input.Password" class="form-control" required placeholder="Mật khẩu" type="password" />
                                    <label asp-for="Input.Password">Mật khẩu</label>
                                    <span asp-validation-for="Input.Password" class="text-danger"></span>
                                </div>
                                <div class="form-floating mb-3">
                                    <input asp-for="Input.ConfirmPassword" class="form-control" required placeholder="Xác nhận mật khẩu" type="password" />
                                    <label asp-for="Input.ConfirmPassword">Xác nhận mật khẩu</label>
                                    <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                                </div>

                                <!-- Role Selection -->
                                <div class="form-floating mb-3">
                                    <select asp-for="Input.Role" asp-items="@Model.Input.RoleList" class="form-control">
                                        <option disabled selected> --- Hãy Chọn Role ---</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Xác thực khuôn mặt -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Xác thực khuôn mặt</h5>
                            </div>
                            <div class="card-body">
                                <!-- CCCD Image Upload -->
                                <div class="form-group mb-3">
                                    <label for="CccdImage"><i class="fas fa-id-card"></i> Ảnh CCCD</label>
                                    <input asp-for="CccdImage" type="file" class="form-control" accept="image/*" required />
                                    <small class="form-text text-muted">Vui lòng tải lên ảnh CCCD rõ nét.</small>
                                </div>

                                <hr class="my-3">

                                <!-- Face Capture -->
                                <div class="form-group">
                                    <label><i class="fas fa-camera"></i> Chụp ảnh khuôn mặt</label>
                                    <div class="text-center mt-2">
                                        <video id="video" width="300" height="225" autoplay class="border rounded"></video>
                                        <div class="mt-2">
                                            <button type="button" id="snap" class="btn btn-secondary">
                                                <i class="fas fa-camera"></i> Chụp ảnh
                                            </button>
                                        </div>
                                        <canvas id="canvas" width="300" height="225" style="display: none;"></canvas>
                                        <input type="hidden" asp-for="CapturedImageBase64" id="CapturedImageBase64" />
                                        <div class="mt-2">
                                            <img id="preview" src="#" class="border rounded" style="display:none; max-width: 300px;" />
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <input type="hidden" asp-for="IsFaceVerified" id="IsFaceVerified" />
                                    <!-- Nút xác thực khuôn mặt -->
                                    <div class="d-grid">
                                        <button type="submit" id="verifyFaceBtn" class="btn btn-warning" name="action" value="verify">
                                            <i class="fas fa-shield-alt"></i> Xác thực khuôn mặt
                                        </button>
                                    </div>
                                </div>

                                <!-- Status alert -->
                                <div id="faceVerificationStatus" class="mt-3">
                                    @if (ViewData["FaceVerifyMessage"] != null)
                                    {
                                        <div class="alert alert-success">
                                            <i class="fas fa-check-circle"></i> @ViewData["FaceVerifyMessage"]
                                        </div>
                                    }
                                    @if (Model.IsFaceVerified)
                                    {
                                        <div class="alert alert-success">
                                            <i class="fas fa-check-circle"></i> Xác thực khuôn mặt thành công!
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Nút đăng ký -->
                        <div class="d-grid mt-4">
                            <button type="submit" id="registerBtn" class="btn btn-primary btn-lg @(Model.IsFaceVerified ? "" : "disabled")"
                                    name="action" value="register" @(Model.IsFaceVerified ? "" : "disabled")>
                                <i class="fas fa-user-plus"></i> Hoàn tất đăng ký
                            </button>
                            @if (!Model.IsFaceVerified)
                            {
                                <small class="form-text text-muted text-center mt-2">
                                    <i class="fas fa-info-circle"></i> Bạn cần xác thực khuôn mặt trước khi đăng ký
                                </small>
                            }
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- External Login Section -->
        <div class="col-md-8 mt-4">
            <section>
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0 text-white">Đăng ký bằng dịch vụ khác</h3>
                    </div>
                    <div class="card-body">
                        @if ((Model.ExternalLogins?.Count ?? 0) == 0)
                        {
                            <div>
                                <p>
                                    Không có dịch vụ xác thực bên ngoài nào được cấu hình. Xem bài viết này <a href="https://go.microsoft.com/fwlink/?LinkID=532715">về cách thiết lập ứng dụng ASP.NET này để hỗ trợ đăng nhập qua các dịch vụ bên ngoài</a>.
                                </p>
                            </div>
                        }
                        else
                        {
                            <form id="external-account" asp-page="./ExternalLogin" asp-route-returnUrl="@Model.ReturnUrl" method="post" class="form-horizontal">
                                <div class="d-grid gap-3">
                                    @foreach (var provider in Model.ExternalLogins)
                                    {
                                        var btnClass = provider.Name switch
                                        {
                                            "Google" => "btn-danger",
                                            "Facebook" => "btn-facebook",
                                            _ => "btn-secondary"
                                        };
                                        <button type="submit" class="btn @btnClass w-100 py-2" name="provider" value="@provider.Name" title="Đăng nhập bằng @provider.DisplayName">
                                            @if (provider.Name == "Google")
                                            {
                                                <i class="fab fa-google me-2"></i>
                                            }
                                            else if (provider.Name == "Facebook")
                                            {
                                                <i class="fab fa-facebook-f me-2"></i>
                                            }
                                            Đăng nhập bằng @provider.DisplayName
                                        </button>
                                    }
                                </div>
                            </form>
                        }
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Camera access and capture
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snap = document.getElementById('snap');
        const preview = document.getElementById('preview');
        const hiddenInput = document.getElementById('CapturedImageBase64');
        const registerBtn = document.getElementById('registerBtn');
        const isFaceVerified = document.getElementById('IsFaceVerified');

        // Initialize camera
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                console.error("Không thể truy cập camera:", err);
                alert("Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập camera của trình duyệt.");
            });

        // Capture image from camera
        snap.addEventListener('click', () => {
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg');
            preview.src = dataUrl;
            preview.style.display = 'block';
            hiddenInput.value = dataUrl;
        });

        // Enable/disable register button based on face verification
        if (isFaceVerified.value === 'True') {
            registerBtn.classList.remove('disabled');
            registerBtn.removeAttribute('disabled');
        }
    </script>
}

<style>
    .btn-facebook {
        background-color: #1877F2;
        color: white;
        border: none;
    }

        .btn-facebook:hover {
            background-color: #145DBF;
            color: white;
        }
</style>