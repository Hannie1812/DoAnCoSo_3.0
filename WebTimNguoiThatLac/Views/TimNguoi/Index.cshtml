@model IPagedList<WebTimNguoiThatLac.Models.TimNguoi>
@using X.PagedList;
@using X.PagedList.Mvc.Core;

@{
    ViewData["Title"] = "Danh Sách Bài Viết";
}

<style >
    /* CSS mới cho thanh tìm kiếm */
    .card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        padding: 10px 15px;
        height: auto;
    }

        .form-control:focus, .form-select:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, 0.25);
        }

    .input-group-text {
        background-color: white;
        border-right: none;
        border-radius: 8px 0 0 8px !important;
    }

    .border-start-0 {
        border-left: none;
        border-radius: 0 8px 8px 0 !important;
    }

    .btn-primary {
        background-color: #4a90e2;
        border-color: #4a90e2;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
    }

    .btn-outline-secondary {
        border-radius: 8px;
        padding: 10px;
    }

    .form-label {
        font-weight: 500;
        color: #555;
    }
    /* Style cho phân trang */
    .pagination {
    margin-top: 20px;
    }

    .page-item .page-link {
    border-radius: 50% !important;
    margin: 0 5px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    color: #333;
    }

    .page-item.active .page-link {
    background-color: #ff6a00; /* Màu cam */
    border-color: #ff6a00;
    color: white;
    }

    .page-item:not(.active) .page-link:hover {
    background-color: #ffe0cc; /* Màu cam nhạt khi hover */
    color: #ff6a00;
    }

    /* Căn giữa toàn bộ phần phân trang */
    .pagination-container {
    display: flex;
    justify-content: center;
    width: 100%;
    }
</style>

<!-- Thêm vào phần đầu trang -->
<div id="notification-area" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<style>
    .notification {
        padding: 15px 20px;
        margin-bottom: 10px;
        border-radius: 5px;
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s, fadeOut 0.5s 4.5s;
        transition: all 0.3s;
    }

        .notification.success {
            background-color: #28a745;
        }

        .notification.error {
            background-color: #dc3545;
        }

        .notification.warning {
            background-color: #ffc107;
            color: #212529;
        }

        .notification.info {
            background-color: #17a2b8;
        }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
        }

        to {
            transform: translateX(0);
        }
    }

    @@keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }
</style>



<!-- Nội dung -->
<!-- Search Form -->
<section class="ftco-section">
    <div class="container">
        <div class="row justify-content-center mb-5">
            <div class="col-md-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-body p-4">
                        <form asp-action="Index" method="get" class="row g-3 align-items-end">
                            <!-- Tên/Tiêu đề -->
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label text-muted small mb-1">Tên/Tiêu đề</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="fas fa-user text-primary"></i>
                                    </span>
                                    <input type="text" name="ten" class="form-control border-start-0 ps-0"
                                           placeholder="Nhập tên hoặc tiêu đề..." value="@ViewBag.TenFilter">
                                </div>
                            </div>

                            <!-- Tỉnh Thành -->
                            <div class="col-lg-2 col-md-6">
                                <label class="form-label text-muted small mb-1">Tỉnh/Thành</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="fas fa-map-marker-alt text-primary"></i>
                                    </span>
                                    <select id="TinhThanh" name="tinhThanhId" class="form-select border-start-0 ps-0" onchange="loadQuanHuyen(this.value)">
                                        <option value="">Tất cả tỉnh</option>
                                        @foreach (var tinh in ViewBag.TinhThanhList as List<TinhThanh>)
                                        {
                                            <option value="@tinh.Id" selected="@(ViewBag.SelectedTinhThanh == tinh.Id ? "selected" : null)">
                                                @tinh.TenTinhThanh
                                            </option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Quận Huyện -->
                            <div class="col-lg-2 col-md-6">
                                <label class="form-label text-muted small mb-1">Quận/Huyện</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="fas fa-map-pin text-primary"></i>
                                    </span>
                                    <select id="QuanHuyen" name="quanHuyenId" class="form-select border-start-0 ps-0">
                                        <option value="">Tất cả quận</option>
                                        @if (ViewBag.SelectedTinhThanh != null)
                                        {
                                            var quanHuyenList = ViewBag.QuanHuyenList as List<QuanHuyen>;
                                            foreach (var huyen in quanHuyenList.Where(q => q.IdTinhThanh == ViewBag.SelectedTinhThanh))
                                            {
                                                <option value="@huyen.Id" selected="@(ViewBag.SelectedQuanHuyen == huyen.Id ? "selected" : null)">
                                                    @huyen.TenQuanHuyen
                                                </option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>


                            <!-- Đặc điểm -->
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label text-muted small mb-1">Đặc điểm</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="fas fa-search text-primary"></i>
                                    </span>
                                    <input type="text" name="dacDiem" class="form-control border-start-0 ps-0"
                                           placeholder="Nhập đặc điểm nhận dạng..." value="@ViewBag.DacDiemFilter">
                                </div>
                            </div>

                            <!-- Nút tìm kiếm -->
                            <div class="col-lg-2 col-md-12">
                                <div class="d-grid gap-2 d-md-flex">
                                    <button type="submit" class="btn btn-primary px-4 flex-grow-1">
                                        <i class="fas fa-search me-2"></i>Tìm
                                    </button>
                                    <a asp-action="Index" class="btn btn-outline-secondary px-3" title="Làm mới">
                                        <i class="fas fa-sync-alt"></i>
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Results -->
        <div class="row">
            @if (Model != null && Model.Any())
            {
                foreach (var i in Model)
                {
                    AnhTimNguoi anhdau = i.AnhTimNguois?.FirstOrDefault(z => z.IdNguoiCanTim == i.Id && z.TrangThai == 1);
                    <div class="col-md-4 ftco-animate">
                        <div class="cause-entry">
                            @if (anhdau!=null)
                            {
                                <a asp-controller="TimNguoi" asp-action="ChiTietBaiTimNguoi" asp-route-id="@i.Id" class="img" style="background-image: url(@anhdau.HinhAnh);"></a>
                            }
                            else
                            {
                                <p class="p-3 text-center">Xem Tin</p>

                            }
                            <div class="text p-3 p-md-4">
                                <h3><a asp-controller="TimNguoi" asp-action="ChiTietBaiTimNguoi" asp-route-id="@i.Id">@i.TieuDe</a></h3>
                                <p>@i.HoTen</p>
                                <p>@i.DaciemNhanDang</p>
                                <span class="donation-time mb-3 d-block">@i.KhuVuc</span>
                                <span class="donation-time mb-3 d-block">@i.NgayDang.ToString()</span>
                                <div class="progress custom-progress-success">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 28%" aria-valuenow="28" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <span class="fund-raised d-block">$12,000 raised of $30,000</span>
                            </div>
                        </div>
                    </div>
                    
                }
            }
            else
            {
                // <div class="col-12 text-center py-5">
                //     <div class="alert alert-info">
                //         <i class="fa fa-info-circle"></i> Không tìm thấy kết quả phù hợp
                //     </div>
                // </div>

                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        @if (!string.IsNullOrEmpty(ViewBag.TenFilter) ||
                       ViewBag.SelectedTinhThanh != null ||
                       ViewBag.SelectedQuanHuyen != null ||
                       !string.IsNullOrEmpty(ViewBag.DacDiemFilter))
                        {
                            <text>Không tìm thấy kết quả phù hợp với tiêu chí tìm kiếm.</text>
                        }
                        else
                        {
                            <text>Hiện chưa có bài đăng nào.</text>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Phân trang -->
        <div class="row mt-5">
            <div class="col-12 d-flex justify-content-center">
                @Html.PagedListPager(Model, page => Url.Action("Index", new
                    {
                        page,
                        ten = ViewBag.TenFilter,
                        tinhThanhId = ViewBag.SelectedTinhThanh,
                        quanHuyenId = ViewBag.SelectedQuanHuyen,
                        dacDiem = ViewBag.DacDiemFilter
                    }), new PagedListRenderOptions
           {
               LiElementClasses = new[] { "page-item" },
               PageClasses = new[] { "page-link" },
               UlElementClasses = new[] { "pagination", "justify-content-center" }
           })

            </div>
        </div>
    </div>
</section>

<section class="ftco-section-3 img" style="background-image: url(/Templet/images/bg_3.jpg);">
    <div class="overlay"></div>
    <div class="container">
        <div class="row d-md-flex">
            <div class="col-md-6 d-flex ftco-animate">
                <div class="img img-2 align-self-stretch" style="background-image: url(/Templet/images/bg_4.jpg);"></div>
            </div>
            <div class="col-md-6 volunteer pl-md-5 ftco-animate">
                <h3 class="mb-3">Be a volunteer</h3>
                <form action="#" class="volunter-form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Your Name">
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Your Email">
                    </div>
                    <div class="form-group">
                        <textarea name="" id="" cols="30" rows="3" class="form-control" placeholder="Message"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="submit" value="Send Message" class="btn btn-white py-3 px-5">
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

@section Scripts {

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
                      function loadQuanHuyen(tinhThanhId) {
            const quanHuyenDropdown = document.getElementById("QuanHuyen");
            quanHuyenDropdown.innerHTML = '<option value="">Tất cả quận</option>';

            if (!tinhThanhId) return;

            fetch(`/TimNguoi/GetQuanHuyenByTinhThanh?tinhThanhId=${tinhThanhId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(huyen => {
                        const option = document.createElement("option");
                        option.value = huyen.id;
                        option.textContent = huyen.tenQuanHuyen;
                        quanHuyenDropdown.appendChild(option);
                    });
                })
                .catch(error => console.error("Error loading districts:", error));
        }

        // Hiển thị thông báo từ TempData
        document.addEventListener('DOMContentLoaded', function() {
            @if (ViewData["Warning"] != null)
            {
                <text>
                            showNotification('warning', '@Html.Raw(ViewData["Warning"])');
                </text>
            }
        });
        

        function showNotification(type, message) {
            console.log("nd:"+message);
            const notificationArea = document.getElementById('notification-area');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${getIconForType(type)} me-2"></i>
                ${message}
            `;

            notificationArea.appendChild(notification);

            // Tự động xóa sau 5 giây
            setTimeout(() => {
                notification.remove();
            }, 5000);

			// Tự động xóa khi nhấn vào
			notification.addEventListener('click', () => {
				notification.remove();
			});

			// Thêm hiệu ứng hover
			notification.addEventListener('mouseover', () => {
				notification.style.transform = 'scale(1.05)';
			});
			notification.addEventListener('mouseout', () => {
				notification.style.transform = 'scale(1)';
			});

			// Thêm hiệu ứng slide-in
			notification.style.transform = 'translateX(100%)';
			setTimeout(() => {
				notification.style.transform = 'translateX(0)';
			}, 10);

            console.log("nd2:"+message+"type:"+type);
            // chuyuển sang trang login
            // Chuyển trang nếu là thông báo đăng nhập
            if (type === 'warning' && message.includes('Bạn đang bị nghi ngờ phá hoại hệ thống. Cần Đăng Nhập Lại')) 
            {
                console.log('Redirect condition met - redirecting to login');
                setTimeout(() => {
                    window.location.href = '/Identity/Account/Login';
                }, 2000);
            }
            
        }    

        function getIconForType(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-bell';
            }
        }
       
    </script>
}