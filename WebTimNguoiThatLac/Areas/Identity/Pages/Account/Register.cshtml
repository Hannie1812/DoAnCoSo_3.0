@page
@model RegisterModel
@{
    ViewData["Title"] = "Đăng ký tài khoản";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0 text-white">Đăng ký tài khoản</h3>
                </div>
                <div class="card-body">
                    <form id="registerForm" asp-route-returnUrl="@Model.ReturnUrl" method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

                        <!-- Email Input -->
                        <div class="form-floating mb-3">
                            <input asp-for="Input.Email" class="form-control" autocomplete="username" required placeholder="name@example.com" />
                            <label asp-for="Input.Email">Email</label>
                            <span asp-validation-for="Input.Email" class="text-danger"></span>
                        </div>

                        <!-- Full Name Input -->
                        <div class="form-floating mb-3">
                            <input asp-for="Input.FullName" class="form-control" required placeholder="Họ và tên" />
                            <label asp-for="Input.FullName">Họ và tên</label>
                            <span asp-validation-for="Input.FullName" class="text-danger"></span>
                        </div>

                        <!-- CCCD Image Upload -->
                        <div class="form-group">
                            <label for="CccdImage">Ảnh CCCD</label>
                            <input asp-for="CccdImage" type="file" class="form-control" accept="image/*" required />
                        </div>

                        <!-- Face Capture -->
                        <div class="form-group">
                            <label>Chụp ảnh khuôn mặt</label><br />
                            <video id="video" width="300" height="225" autoplay></video><br />
                            <button type="button" id="snap" class="btn btn-secondary mt-2">Chụp ảnh</button>
                            <canvas id="canvas" width="300" height="225" style="display: none;"></canvas>
                            <input type="hidden" asp-for="CapturedImageBase64" />
                            <img id="preview" src="#" style="display:none;" />
                        </div>
                        <!-- Thêm trường ẩn -->
                        <input type="hidden" asp-for="IsFaceVerified" id="IsFaceVerified" />
                        <!-- Nút xác thực khuôn mặt -->
                        <button type="submit" class="btn btn-warning" name="action" value="verify">
                            Xác thực khuôn mặt
                        </button>
                        <!-- CCCD Number Input -->
                        <div class="form-group mb-3">
                            <label asp-for="Input.CCCD"><i class="fas fa-id-card"></i> Số CCCD</label>
                            <input asp-for="Input.CCCD" id="cccdInput" class="form-control" required />
                            <span asp-validation-for="Input.CCCD" class="text-danger"></span>
                        </div>

                        <!-- Address Input -->
                        <div class="form-floating mb-3">
                            <input asp-for="Input.Address" class="form-control" required placeholder="Địa chỉ" />
                            <label asp-for="Input.Address">Địa chỉ</label>
                            <span asp-validation-for="Input.Address" class="text-danger"></span>
                        </div>

                        <!-- Password Inputs -->
                        <div class="form-floating mb-3">
                            <input asp-for="Input.Password" class="form-control" required placeholder="Mật khẩu" type="password" />
                            <label asp-for="Input.Password">Mật khẩu</label>
                            <span asp-validation-for="Input.Password" class="text-danger"></span>
                        </div>
                        <div class="form-floating mb-3">
                            <input asp-for="Input.ConfirmPassword" class="form-control" required placeholder="Xác nhận mật khẩu" type="password" />
                            <label asp-for="Input.ConfirmPassword">Xác nhận mật khẩu</label>
                            <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                        </div>

                        <!-- Role Selection -->
                        <div class="form-floating mb-3">
                            <select asp-for="Input.Role" asp-items="@Model.Input.RoleList" class="form-control">
                                <option disabled selected> --- Hãy Chọn Role ---</option>
                            </select>
                        </div>

                        <!-- Nút đăng ký -->
                        <button type="submit" class="btn btn-primary" name="action" value="register">
                            Đăng ký
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- External Login Section -->
        <div class="col-md-8 mt-4">
            <section>
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0 text-white">Đăng ký bằng dịch vụ khác</h3>
                    </div>
                    <div class="card-body">
                        @if ((Model.ExternalLogins?.Count ?? 0) == 0)
                        {
                            <div>
                                <p>
                                    Không có dịch vụ xác thực bên ngoài nào được cấu hình. Xem bài viết này <a href="https://go.microsoft.com/fwlink/?LinkID=532715">về cách thiết lập ứng dụng ASP.NET này để hỗ trợ đăng nhập qua các dịch vụ bên ngoài</a>.
                                </p>
                            </div>
                        }
                        else
                        {
                            <form id="external-account" asp-page="./ExternalLogin" asp-route-returnUrl="@Model.ReturnUrl" method="post" class="form-horizontal">
                                <div class="d-grid gap-3">
                                    @foreach (var provider in Model.ExternalLogins)
                                    {
                                        var btnClass = provider.Name switch
                                        {
                                            "Google" => "btn-danger",
                                            "Facebook" => "btn-facebook",
                                            _ => "btn-secondary"
                                        };
                                        <button type="submit" class="btn @btnClass w-100 py-2" name="provider" value="@provider.Name" title="Đăng nhập bằng @provider.DisplayName">
                                            @if (provider.Name == "Google")
                                            {
                                                <i class="fab fa-google me-2"></i>
                                            }
                                            else if (provider.Name == "Facebook")
                                            {
                                                <i class="fab fa-facebook-f me-2"></i>
                                            }
                                            Đăng nhập bằng @provider.DisplayName
                                        </button>
                                    }
                                </div>
                            </form>
                        }
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
@if (ViewData["FaceVerifyMessage"] != null)
{
    <div class="alert alert-success">@ViewData["FaceVerifyMessage"]</div>
}
@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snap = document.getElementById('snap');
        const preview = document.getElementById('preview');
        const hiddenInput = document.getElementById('CapturedImageBase64');

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => { video.srcObject = stream; })
            .catch(err => { console.error("Không thể truy cập camera:", err); });

        snap.addEventListener('click', () => {
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg');
            preview.src = dataUrl;
            preview.style.display = 'block';
            hiddenInput.value = dataUrl;
        });
    </script>
}

<style>
    .btn-facebook {
        background-color: #1877F2;
        color: white;
        border: none;
    }

        .btn-facebook:hover {
            background-color: #145DBF;
            color: white;
        }
</style>
